<div class="app-shell">
    <div class="glass-bg"></div>

    <div class="page">
        <div class="top-pill">COTIZACIÓN No {{cotizacionNoLabel$ | async}}</div>

        <form class="card form-card" [formGroup]="form" (ngSubmit)="generarPlan()">


            <div class="fieldset">
                <div class="legend">INFORMACIÓN DE USUARIO</div>
                <!-- Información del usuario -->
                <div class="grid grid-2">
                    <div class="field">
                        <label>Tipo de documento</label>
                        <select formControlName="tipoDocumento">
                            <option value="" disabled>Seleccionar</option>
                            <option value="CC">CC</option>
                            <option value="CE">PPT</option>
                            <option value="NIT">PASAPORTE</option>
                            <option value="PAS">CE</option>
                        </select>
                        <small class="error" *ngIf="isInvalid('tipoDocumento')"> {{ getErrorMessage('tipoDocumento')
                            }}</small>
                    </div>

                    <div class="field">
                        <label>Número de documento</label>
                        <input type="text" class="no-spinners" formControlName="noDocumento" min="0" inputmode="numeric"
                            placeholder="Ingrese un numero de documento" />
                        <small class="error" *ngIf="isInvalid('noDocumento')"> {{ getErrorMessage('noDocumento')
                            }}</small>
                    </div>

                    <div class="field">
                        <label>Nombres</label>
                        <input type="text" formControlName="nombres" placeholder="Ingrese los nombres" />
                        <small class="error" *ngIf="isInvalid('nombres')"> {{ getErrorMessage('nombres') }}</small>
                    </div>

                    <div class="field">
                        <label>Apellidos</label>
                        <input type="text" formControlName="apellidos" placeholder="Ingrese los apellidos" />
                        <small class="error" *ngIf="isInvalid('apellidos')"> {{ getErrorMessage('apellidos') }}</small>
                    </div>

                    <div class="field">
                        <label>Dirección</label>
                        <input type="text" formControlName="direccion" placeholder="Ingrese una dirección" />
                        <small class="error" *ngIf="isInvalid('direccion')"> {{ getErrorMessage('direccion') }}</small>
                    </div>

                    <div class="field">
                        <label>Teléfono</label>
                        <input type="tel" formControlName="telefono" placeholder="Ingrese un número de teléfono" />
                        <small class="error" *ngIf="isInvalid('telefono')"> {{ getErrorMessage('telefono') }}</small>
                    </div>

                    <div class="field">
                        <label>Correo electrónico</label>
                        <input type="email" formControlName="correo" placeholder="Ej: correo@ejemplo.com" />
                        <small class="error" *ngIf="isInvalid('correo')"> {{ getErrorMessage('correo') }}</small>
                    </div>

                    <div class="field">
                        <label>Canal</label>
                        <select formControlName="canal">
                            <option value="" disabled>Seleccionar</option>
                            <option value="whatsapp">WHATSAPP</option>
                            <option value="telefono">TELEFONO</option>
                            <option value="email">EMAIL</option>
                        </select>
                        <small class="error" *ngIf="isInvalid('canal')"> {{ getErrorMessage('canal') }}</small>
                    </div>
                </div>
            </div>

            <div class="section-title"></div>

            <div class="fieldset">
                <div class="legend">INFORMACIÓN DEL APARTAMENTO</div>

                <!-- 1) SELECCIÓN (3 columnas) -->

                <div class="grid grid-3 info-grid">

                    <div class="field">
                        <label>Proyecto</label>
                        <select formControlName="proyecto">
                            <option [ngValue]="null" disabled>Seleccionar</option>

                            <option *ngIf="cargandoProyectos" [ngValue]="null" disabled>
                                Cargando proyectos...
                            </option>

                            <option *ngFor="let a of proyectos" [ngValue]="a.id">
                                {{ a.nombre }}
                            </option>
                        </select>

                        <small class="error" *ngIf="errorProyectos">{{ errorProyectos }}</small>
                        <small class="error" *ngIf="isInvalid('proyecto')">{{ getErrorMessage('proyecto') }}</small>
                    </div>

                    <div class="field">
                        <label>Torre</label>
                        <select formControlName="torre">
                            <option [ngValue]="null" disabled>Seleccionar</option>
                            <option *ngIf="cargandoApartamentos" [ngValue]="null" disabled>Cargando...</option>
                            <option *ngFor="let t of torres" [value]="t">{{ t }}</option>
                        </select>
                        <small class="error" *ngIf="isInvalid('torre')">{{ getErrorMessage('torre') }}</small>
                    </div>

                    <div class="field">
                        <label>Apartamento</label>
                        <select formControlName="apartamento">
                            <option [ngValue]="null" disabled>Seleccionar</option>
                            <option *ngFor="let a of apartamentosFiltrados" [ngValue]="a.id">
                                {{ a.numero_apto }}
                            </option>
                        </select>
                        <small class="error" *ngIf="isInvalid('apartamento')">{{ getErrorMessage('apartamento')
                            }}</small>
                    </div>

                    <!-- 2) VALOR TOTAL (full width) -->
                    <div class="field full">
                        <label>Valor total</label>
                        <input id="ValorTotal" type="text" appCopCurrency formControlName="valorTotal"
                            placeholder="$" />
                        <small class="error" *ngIf="isInvalid('valorTotal')">{{ getErrorMessage('valorTotal') }}</small>
                    </div>
                </div>

                <!-- 3) BENEFICIOS (2 cards con concepto) -->
                <div class="benefits-grid">
                    <!-- Beneficio 1 -->
                    <div class="benefit-card">
                        <div class="benefit-head">Beneficio 1</div>

                        <div class="field">
                            <label>Valor</label>
                            <input type="text" appCopCurrency formControlName="beneficioValorizacion" placeholder="$" />
                            <small class="error" *ngIf="isInvalid('beneficioValorizacion')">
                                {{ getErrorMessage('beneficioValorizacion') }}
                            </small>
                        </div>

                        <div class="field">
                            <label>Concepto</label>
                            <textarea rows="3" formControlName="conceptoBeneficioValorizacion"
                                placeholder="Ingrese un motivo del beneficio"></textarea>
                        </div>
                    </div>

                    <!-- Beneficio 2 -->
                    <div class="benefit-card">
                        <div class="benefit-head">Beneficio 2</div>

                        <div class="field">
                            <label>Valor</label>
                            <input type="text" appCopCurrency formControlName="beneficioProntaSeparacion"
                                placeholder="$" />
                            <small class="error" *ngIf="isInvalid('beneficioProntaSeparacion')">
                                {{ getErrorMessage('beneficioProntaSeparacion') }}
                            </small>
                        </div>

                        <div class="field">
                            <label>Concepto</label>
                            <textarea rows="3" formControlName="conceptoBeneficioProntaSeparacion"
                                placeholder="Ingrese un motivo del beneficio"></textarea>
                        </div>
                    </div>
                </div>

                <div class="grid grid-3 finance-grid">
                    <div class="field">
                        <label>Valor especial hoy</label>
                        <input appCopCurrency type="text" formControlName="valorEspecialHoy" placeholder="$" />
                        <small class="error" *ngIf="isInvalid('valorEspecialHoy')">{{
                            getErrorMessage('valorEspecialHoy') }}</small>
                    </div>

                    <div class="field">
                        <label>% Cuota inicial</label>
                        <select formControlName="porcentajeCuotaInicial"
                            [class.invalid]="isInvalid('porcentajeCuotaInicial')">
                            <option *ngFor="let p of porcentajesCuotaInicial" [value]="p">{{ p }}%</option>
                        </select>
                        <small class="error" *ngIf="isInvalid('porcentajeCuotaInicial')">
                            {{ getErrorMessage('porcentajeCuotaInicial') }}
                        </small>
                    </div>

                    <div class="field">
                        <label>Valor cuota inicial</label>
                        <input appCopCurrency type="text" formControlName="valorCuotaInicial" placeholder="$" />
                        <small class="error" *ngIf="isInvalid('valorCuotaInicial')">{{
                            getErrorMessage('valorCuotaInicial') }}</small>
                    </div>

                    <div class="field">
                        <label>Fecha de la última cuota</label>
                        <input type="date" formControlName="fechaUltimaCuota" />
                        <small class="error" *ngIf="isInvalid('fechaUltimaCuota')">{{
                            getErrorMessage('fechaUltimaCuota') }}</small>
                    </div>

                    <div class="field">
                        <label>Cantidad de cuotas</label>
                        <input type="number" class="no-spinners" formControlName="cantidadCuotas" />
                        <small class="error" *ngIf="isInvalid('cantidadCuotas')">{{ getErrorMessage('cantidadCuotas')
                            }}</small>
                    </div>

                    <div class="field">
                        <label>&nbsp;</label> <!-- para alinear con los demás -->
                        <div class="inline-check input-like">
                            <span>Aprobador</span>
                            <input type="checkbox" formControlName="aprobador" />
                        </div>
                    </div>


                    <div class="field" style="visibility:hidden;"></div>
                </div>
            </div>


            <div class="section-title"></div>

            <div class="fieldset">
                <div class="legend">INFORMACIÓN DE ADICIONALES</div>

                <!-- Iteración dinámica sobre todos los adicionales -->
                <ng-container *ngFor="let config of adicionalesConfig; let last = last">
                    <div class="stack">
                        <div class="check-row">
                            <span>{{ config.displayName }}</span>
                            <input type="checkbox" [formControlName]="config.formControls.checkbox" />
                        </div>
                    </div>

                    <div class="grid grid-2" *ngIf="form.get(config.formControls.checkbox)?.value">
                        <!-- Campo de cantidad solo si es necesario -->
                        <div class="field" *ngIf="config.hasQuantity && config.formControls.cantidad">
                            <label>Cantidad</label>
                            <select [formControlName]="config.formControls.cantidad">
                                <option value="1">1</option>
                                <option value="2">2</option>
                            </select>
                            <small class="error" *ngIf="isInvalid(config.formControls.cantidad)">
                                {{ getErrorMessage(config.formControls.cantidad) }}
                            </small>
                        </div>

                        <div class="field">
                            <label>Valor total de {{ config.displayName.toLowerCase() }}</label>
                            <input type="text" appCopCurrency [formControlName]="config.formControls.valorTotal"
                                placeholder="$" />
                            <small class="error" *ngIf="isInvalid(config.formControls.valorTotal)">
                                {{ getErrorMessage(config.formControls.valorTotal) }}
                            </small>
                        </div>

                        <div class="field">
                            <label>Beneficio {{ config.displayName.toLowerCase() }}</label>
                            <input type="text" appCopCurrency [formControlName]="config.formControls.beneficio"
                                placeholder="$" />
                            <small class="error" *ngIf="isInvalid(config.formControls.beneficio)">
                                {{ getErrorMessage(config.formControls.beneficio) }}
                            </small>
                        </div>

                        <div class="field">
                            <label>Valor cuota {{ config.displayName.toLowerCase() }}</label>
                            <input type="text" class="no-spinners" appCopCurrency
                                [formControlName]="config.formControls.valorCuota" placeholder="$" />
                            <small class="error" *ngIf="isInvalid(config.formControls.valorCuota)">
                                {{ getErrorMessage(config.formControls.valorCuota) }}
                            </small>
                        </div>

                        <div class="field">
                            <label>Fecha última cuota</label>
                            <input type="date" [formControlName]="config.formControls.fechaUltimaCuota" />
                            <small class="error" *ngIf="isInvalid(config.formControls.fechaUltimaCuota)">
                                {{ getErrorMessage(config.formControls.fechaUltimaCuota) }}
                            </small>
                        </div>

                        <div class="field">
                            <label>Cuotas de financiación</label>
                            <input type="number" class="no-spinners"
                                [formControlName]="config.formControls.cuotasFinanciacion" />
                            <small class="error" *ngIf="isInvalid(config.formControls.cuotasFinanciacion)">
                                {{ getErrorMessage(config.formControls.cuotasFinanciacion) }}
                            </small>
                        </div>
                    </div>

                    <!-- Separador entre adicionales (excepto el último) -->
                    <div class="section-title" *ngIf="!last"></div>
                </ng-container>

            </div>

            <div class="section-title"></div>

            <div class="fieldset">
                <div class="legend">INFORMACIÓN DE COTIZACIÓN</div>

                <div class="grid-2-split">
                    <!-- Izquierda: inputs ordenados -->
                    <div class="stack">
                        <div class="field">
                            <label>Nombre del ejecutivo</label>
                            <select formControlName="nombreEjecutivo">
                                <option [ngValue]="null" disabled>Seleccionar</option>

                                <option *ngIf="cargandoAsesores" [ngValue]="null" disabled>
                                    Cargando asesores...
                                </option>

                                <option *ngFor="let a of asesores" [ngValue]="a.id">
                                    {{ a.nombre_completo }}
                                </option>
                            </select>

                            <small class="error" *ngIf="errorAsesores">{{ errorAsesores }}</small>
                            <small class="error" *ngIf="isInvalid('nombreEjecutivo')">
                                {{ getErrorMessage('nombreEjecutivo') }}
                            </small>

                        </div>

                        <div class="field">
                            <label>Teléfono</label>
                            <input type="number" class="no-spinners" formControlName="telefonoEjecutivo"
                                placeholder="Ingrese un número de telefono" />
                            <small class="error" *ngIf="isInvalid('telefonoEjecutivo')"> {{
                                getErrorMessage('telefonoEjecutivo') }}</small>
                        </div>



                        <div class="field">
                            <label>Correo electrónico</label>
                            <input type="email" formControlName="correoEjecutivo"
                                placeholder="Ej: correo@ejemplo.com" />
                            <small class="error" *ngIf="isInvalid('correoEjecutivo')"> {{
                                getErrorMessage('correoEjecutivo') }}</small>
                        </div>

                        <div class="field">
                            <label>Cotización válida hasta</label>
                            <input type="date" formControlName="cotizacionValidaHasta" />
                            <small class="error" *ngIf="isInvalid('cotizacionValidaHasta')"> {{
                                getErrorMessage('cotizacionValidaHasta') }}</small>
                        </div>
                    </div>

                    <!-- Derecha: lista de checks estilo “clásico” -->
                    <div class="stack checks-panel">
                        <div class="check-row">
                            <span>Concepto Ciudad Viva</span>
                            <input type="checkbox" formControlName="conceptoCiudadViva" />
                        </div>

                        <div class="check-row">
                            <span>Actividades del Proyecto</span>
                            <input type="checkbox" formControlName="actividadesProyecto" />
                        </div>

                        <div class="check-row">
                            <span>Link 360</span>
                            <input type="checkbox" formControlName="link360" />
                        </div>

                        <div class="check-row">
                            <span>Cotización en dólares</span>
                            <input type="checkbox" formControlName="cotizacionDolares" />
                        </div>
                    </div>
                </div>
            </div>


            <div class="actions">
                <button type="submit" class="btn primary">Generar Plan de pagos</button>
                <button type="button" class="btn ghost" (click)="limpiarTodo()">Limpiar</button>

            </div>
        </form>

        <!-- Contenedor Grid para ambos planes lado a lado -->
        <div class="plans-grid" *ngIf="showPlan" [class.single-column]="getAdicionalesSeleccionados().length === 0">
            <!-- SECCIÓN 1: Plan de Pagos del Apartamento -->
            <div class="card table-card" [formGroup]="form">

                <div class="section-title"></div>

                <div class="fieldset">
                    <div class="legend">PLAN DE PAGOS DEL APARTAMENTO</div>

                    <div class="table-wrap">
                        <table class="plan-table">
                            <thead>
                                <tr>
                                    <th class="center">No.</th>
                                    <th class="center">Fecha Cuota</th>
                                    <th class="center">Valor Cuota</th>
                                </tr>
                            </thead>

                            <tbody formArrayName="plan">
                                <tr *ngFor="let row of plan.controls; let i = index" [formGroupName]="i">
                                    <td class="center">{{ i + 1 }}</td>
                                    <td>
                                        <input class="cell" type="date" formControlName="fechaApto" />
                                    </td>
                                    <td>
                                        <input class="cell" type="text" appCopCurrency formControlName="valorApto"
                                            placeholder="$" />
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 2: Plan de Pagos de Adicionales con Tabs -->
            <div class="card table-card" *ngIf="getAdicionalesSeleccionados().length > 0">

                <div class="section-title"></div>

                <div class="fieldset">
                    <div class="legend">PLAN DE PAGOS DE ADICIONALES</div>

                    <!-- Navegación de Tabs -->
                    <div class="tabs-nav">
                        <button *ngFor="let config of getAdicionalesSeleccionados()" type="button" class="tab-btn"
                            [class.active]="tabActivoAdicional === config.id" (click)="cambiarTabAdicional(config.id)">
                            {{ config.displayName }}
                        </button>
                    </div>

                    <!-- Contenido de cada Tab -->
                    <div *ngFor="let config of getAdicionalesSeleccionados()" class="tab-content"
                        [hidden]="tabActivoAdicional !== config.id">
                        <div class="table-wrap">
                            <table class="plan-table">
                                <thead>
                                    <tr>
                                        <th class="center">No.</th>
                                        <th class="center">Fecha Cuota</th>
                                        <th class="center">Valor Cuota</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr *ngFor="let item of planesAdicionales.get(config.id); let i = index">
                                        <td class="center">{{ i + 1 }}</td>
                                        <td>
                                            <input class="cell" type="date" [value]="item.fecha" readonly />
                                        </td>
                                        <td>
                                            <input class="cell" type="text"
                                                [value]="item.valor | currency:'CAD':'symbol-narrow':'1.0-0'"
                                                [disabled]="true" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones al final de ambos planes -->
        <div class="actions center" *ngIf="showPlan">
            <button type="button" class="btn primary" (click)="generarCotizacion()">Generar Cotización</button>
        </div>
    </div>
</div>